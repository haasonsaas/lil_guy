#!/usr/bin/env sh

echo "ðŸ” Running pre-commit checks..."

# Check for TypeScript errors
echo "ðŸ“˜ Checking TypeScript..."
if ! bun run typecheck; then
  echo "âŒ TypeScript errors found. Please fix before committing."
  exit 1
fi

# Check for ESLint errors (not warnings)
echo "ðŸ”§ Running ESLint..."
if ! bun run lint; then
  echo "âŒ ESLint errors found. Please fix before committing."
  exit 1
fi

# Check for secrets or API keys in staged files (exclude lock files and this hook)
echo "ðŸ”’ Scanning for secrets..."
staged_files=$(git diff --cached --name-only | grep -v "\.lock$\|\.husky/pre-commit$" || true)
if [ -n "$staged_files" ]; then
  # Look for actual secret patterns, not references to the patterns
  secret_matches=$(echo "$staged_files" | xargs grep -l "sk_[a-zA-Z0-9]\|pk_[a-zA-Z0-9]\|['\"]api_key['\"]:\s*['\"][a-zA-Z0-9]\|['\"]secret_key['\"]:\s*['\"][a-zA-Z0-9]\|password.*=.*[a-zA-Z0-9]" 2>/dev/null || true)
  if [ -n "$secret_matches" ]; then
    echo "âŒ Potential secrets found in staged files:"
    echo "$secret_matches" | xargs grep -n "sk_[a-zA-Z0-9]\|pk_[a-zA-Z0-9]\|['\"]api_key['\"]:\s*['\"][a-zA-Z0-9]\|['\"]secret_key['\"]:\s*['\"][a-zA-Z0-9]\|password.*=.*[a-zA-Z0-9]" 2>/dev/null
    echo "Please remove secrets before committing."
    exit 1
  fi
fi

# Validate frontmatter for any modified markdown files
echo "ðŸ“ Validating blog post frontmatter..."
modified_posts=$(git diff --cached --name-only | grep "src/posts/.*\.md$" || true)
if [ -n "$modified_posts" ]; then
  # Build to trigger validation (suppress output unless there are errors)
  if ! bun run build >/dev/null 2>&1; then
    echo "âŒ Build failed, likely due to frontmatter validation errors."
    echo "Run 'bun run build' to see specific validation messages."
    exit 1
  fi
fi

# Generate blog images for any new or modified markdown files
if [ -n "$modified_posts" ]; then
  echo "ðŸ–¼ï¸  Generating blog images for modified posts..."
  bun run generate-blog-images >/dev/null 2>&1
  
  # Add any newly generated images to the commit
  git add public/generated/*.png 2>/dev/null || true
fi

# Check for large files (>5MB)
echo "ðŸ“ Checking file sizes..."
large_files=$(git diff --cached --name-only | xargs ls -la 2>/dev/null | awk '$5 > 5242880 {print $9 " (" $5 " bytes)"}' || true)
if [ -n "$large_files" ]; then
  echo "âš ï¸  Large files detected (>5MB):"
  echo "$large_files"
  echo "Consider optimizing or using Git LFS for these files."
  # Don't exit - just warn
fi

# Verify CLAUDE.md is up to date if scripts were modified
modified_scripts=$(git diff --cached --name-only | grep "scripts/\|package.json" || true)
if [ -n "$modified_scripts" ]; then
  echo "ðŸ“š Scripts modified - consider updating CLAUDE.md if new commands were added"
fi

# Check for console.log in TypeScript files (excluding tests and build files)
echo "ðŸ§¹ Checking for console.log statements..."
console_logs=$(git diff --cached --name-only | grep "\.ts$\|\.tsx$" | grep -v "test\|spec\|\.d\.ts" | xargs grep -n "console\.log" 2>/dev/null || true)
if [ -n "$console_logs" ]; then
  echo "âš ï¸  console.log statements found:"
  echo "$console_logs"
  echo "Consider removing or using proper logging before committing."
  # Don't exit - just warn
fi

# Markdown linting for modified posts
if [ -n "$modified_posts" ]; then
  echo "ðŸ“– Linting markdown files..."
  if ! echo "$modified_posts" | xargs npx markdownlint-cli2 --config .markdownlint.json 2>/dev/null; then
    echo "âš ï¸  Markdown linting issues found. Run 'npx markdownlint-cli2 src/posts/*.md' to see details."
    # Don't exit - just warn for markdown linting
  fi
fi

# Spell checking for modified posts
if [ -n "$modified_posts" ]; then
  echo "ðŸ“ Spell checking blog posts..."
  if ! echo "$modified_posts" | xargs npx cspell --config cspell.json --no-progress 2>/dev/null; then
    echo "âš ï¸  Spelling issues found. Run 'npx cspell src/posts/*.md' to see details."
    echo "ðŸ’¡ Add technical terms to cspell.json words array if needed."
    # Don't exit - just warn for spelling
  fi
fi

# Link validation for modified posts (async, don't block)
if [ -n "$modified_posts" ]; then
  echo "ðŸ”— Checking links in background..."
  (
    for file in $modified_posts; do
      npx markdown-link-check "$file" --config .markdown-link-check.json >/dev/null 2>&1 || \
      echo "âš ï¸  Broken links found in $file. Run 'npx markdown-link-check $file' to check manually."
    done
  ) &
fi

# Image optimization check for any new images
new_images=$(git diff --cached --name-only | grep -E "\.(png|jpg|jpeg|webp|svg)$" || true)
if [ -n "$new_images" ]; then
  echo "ðŸ–¼ï¸  Checking image sizes..."
  large_images=$(echo "$new_images" | xargs ls -la 2>/dev/null | awk '$5 > 1048576 {print $9 " (" int($5/1024) "KB)"}' || true)
  if [ -n "$large_images" ]; then
    echo "âš ï¸  Large images detected (>1MB):"
    echo "$large_images"
    echo "ðŸ’¡ Consider optimizing these images before committing."
    # Don't exit - just warn
  fi
fi

# Generate RSS feed if posts were modified
if [ -n "$modified_posts" ]; then
  echo "ðŸ“¡ Regenerating RSS feed..."
  bun run generate-rss >/dev/null 2>&1
  git add dist/rss.xml 2>/dev/null || true
fi

echo "âœ… All pre-commit checks passed!"